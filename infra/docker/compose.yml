services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.6
    container_name: fxai-clickhouse
    restart: unless-stopped
    ports: ["8123:8123", "9000:9000"]
    ulimits:
      nofile: { soft: 262144, hard: 262144 }
    volumes:
      - ch_data:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_DB=fxai
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8123/ping || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.1.3
    container_name: fxai-redpanda
    restart: unless-stopped
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --reserve-memory
      - 0M
      - --node-id
      - "0"
      - --kafka-addr
      - INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:19092
      - --advertise-kafka-addr
      - INTERNAL://redpanda:9092,EXTERNAL://localhost:19092
    ports: ["9092:9092", "19092:19092"]
    volumes:
      - rp_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "rpk", "cluster", "info", "-X", "brokers=localhost:19092"]
      interval: 10s
      timeout: 5s
      retries: 5

  console:
    image: docker.redpanda.com/redpandadata/console:v3.2.0
    container_name: fxai-console
    restart: unless-stopped
    environment:
      - KAFKA_BROKERS=redpanda:9092
    ports: ["8081:8080"]
    depends_on: [redpanda]
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  featurizer:
    build:
      context: ../..
      dockerfile: Dockerfile
    environment:
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DB: fxai
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      FEAT_PAIRS: ${FEAT_PAIRS:-USDINR}
      FEAT_INTERVAL_SEC: ${FEAT_INTERVAL_SEC:-60}
      FEAT_LOOKBACK_MIN: ${FEAT_LOOKBACK_MIN:-360}
    command: >
      python -m apps.workers.featurizer_daemon
      --pairs ${FEAT_PAIRS:-USDINR}
      --interval ${FEAT_INTERVAL_SEC:-60}
      --lookback-minutes ${FEAT_LOOKBACK_MIN:-360}
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped
  backtester:
    build:
      context: ../..
      dockerfile: Dockerfile
    environment:
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DB: fxai
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      BT_PAIR: ${BT_PAIR:-USDINR}
      BT_HORIZON: ${BT_HORIZON:-4h}
      BT_LOOKBACK_HOURS: ${BT_LOOKBACK_HOURS:-24}
      BT_PROB_TH: ${BT_PROB_TH:-0.6}
      BT_SPREAD_BPS: ${BT_SPREAD_BPS:-2.0}
      BT_GATE_EXPECTED: ${BT_GATE_EXPECTED:-false}
      BT_INTERVAL_SEC: ${BT_INTERVAL_SEC:-900}
    command: >
      python -m apps.workers.backtest_daemon
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped

volumes:
  ch_data: {}
  rp_data: {}